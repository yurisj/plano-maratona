<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Maratona de Buenos Aires</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            line-height: 1.6;
            margin: 0;
            padding: 20px;
            background-color: #f4f4f4;
            color: #333;
            display: flex;
            flex-direction: column;
            align-items: center;
        }
        .container {
            background: #fff;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 0 10px rgba(0,0,0,0.1);
            width: 90%;
            max-width: 700px;
            text-align: center;
            margin-bottom: 20px;
        }
        h1 {
            color: #333;
            margin-bottom: 10px;
            font-size: 1.2em;
        }
        #currentDisplayedDate {
            font-weight: bold;
            color: #007bff;
            margin-bottom: 20px;
            font-size: 1.1em;
        }
        .workout-details {
            text-align: left;
            padding: 15px;
            border: 1px solid #ddd;
            border-radius: 5px;
            background-color: #f9f9f9;
            margin-top: 15px;
        }
        .workout-title {
            font-weight: bold;
            font-size: 1.2em;
            color: #28a745;
        }
        .workout-notes {
            font-style: italic;
            color: #666;
            margin-top: 5px;
            font-size: 0.9em;
        }
        #workoutStatus {
            font-weight: bold;
        }
        .status-feito {
            color: green;
        }
        .status-nao-feito {
            color: red;
        }
        
        /* Estilos para o botão de status */
        #markAsDoneButton {
            margin-left: 10px; 
            padding: 5px 10px;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 0.9em;
            transition: background-color 0.3s ease;
        }

        .button-mark-done { /* Estilo para o botão "Marcar como Feito" (verde) */
            background-color: #28a745; 
        }
        .button-mark-done:hover:not(:disabled) {
            background-color: #218838; 
        }

        .button-mark-not-done { /* Estilo para o botão "Marcar como Não Feito" (vermelho) */
            background-color: #dc3545; 
        }
        .button-mark-not-done:hover:not(:disabled) {
            background-color: #c82333; 
        }

        #markAsDoneButton:disabled { /* Estilo para botão desabilitado (se necessário no futuro) */
            background-color: #6c757d; 
            cursor: not-allowed;
        }

        .message {
            margin-top: 20px;
            padding: 10px;
            border-radius: 5px;
            font-weight: bold;
        }
        .info-message { background-color: #e2f3ff; color: #004085; border: 1px solid #b8daff; }
        .success-message { background-color: #d4edda; color: #155724; border: 1px solid #c3e6cb; }
        .warning-message { background-color: #fff3cd; color: #856404; border: 1px solid #ffeeba; }
        .error-message { background-color: #f8d7da; color: #721c24; border: 1px solid #f5c6cb; }
        .race-day { color: #dc3545 !important; font-weight: bold; font-size: 1.3em; }
        .rest-day { color: #17a2b8 !important; }

        .search-area, .navigation-area {
            margin-top: 20px;
            padding: 15px;
            background-color: #e9ecef;
            border-radius: 5px;
        }
        .search-area label, .search-area input, .search-area button, .navigation-area button {
            margin: 5px;
            padding: 8px;
            border-radius: 4px;
            border: 1px solid #ccc;
        }
        .search-area input[type="date"] {
            padding: 6px;
        }
        .search-area button, .navigation-area button {
            background-color: #007bff;
            color: white;
            cursor: pointer;
            border-color: #007bff;
        }
        .search-area button:hover, .navigation-area button:hover {
            background-color: #0056b3;
        }
        .navigation-area {
            display: flex;
            justify-content: space-between;
        }
        .current-view-label {
            font-size: 0.9em;
            color: #6c757d;
            margin-bottom: 5px;
        }

    </style>
</head>
<body>
    <div class="container">
        <h1>Maratona de Buenos Aires 2025</h1>
        <p class="current-view-label">Exibindo treino para:</p>
        <p id="currentDisplayedDate"></p>

        <div id="workoutInfo">
            <div class="workout-details">
                <p><strong>Semana:</strong> <span id="weekNumber">-</span> | <strong>Dia:</strong> <span id="dayOfWeek">-</span></p>
                <p class="workout-title" id="workoutDescription">Carregando treino...</p>
                <p class="workout-notes" id="workoutNotes"></p>
                <p><strong>Status:</strong> <span id="workoutStatus">-</span></p>
                <p><button id="markAsDoneButton" style="display: none;"></button></p>
            </div>
            <p id="generalMessage" class="message"></p>
        </div>
    </div>
    
    <div class="container navigation-area">
        <button id="prevDayButton">« Dia Anterior</button>
        <button id="todayButton">Ver Treino de Hoje</button>
        <button id="nextDayButton">Próximo Dia »</button>
    </div>
    
    <div class="container search-area">
        <h2>Buscar Treino por Data</h2>
        <label for="searchDate">Escolha uma data:</label>
        <input type="date" id="searchDate">
        <button id="searchButton">Buscar</button>
    </div>

    <script>
       // Coloque esta constante no topo do seu <script> no index.html
const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbzVp_qlSX8wvQYU5qcj4wNVjgWuBEL3bngGuWvOfDksgtdxp4OlnNcN8yTlQnFIhpLZ/exec"; // !!! SUBSTITUA PELA SUA URL !!!

let currentTrainingPlan = null;
let currentlyDisplayedDate = new Date();

// Função para formatar a data como YYYY-MM-DD (já existente)
function getFormattedDate(date) {
    const year = date.getFullYear();
    const month = (date.getMonth() + 1).toString().padStart(2, '0');
    const day = date.getDate().toString().padStart(2, '0');
    return `${year}-${month}-${day}`;
}

// Função para formatar a data para exibição (dd/mm/aaaa, Dia da Semana) (já existente)
function getDisplayFormattedDate(date) {
    return date.toLocaleDateString('pt-BR', { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' });
}

// MODIFICADA: Carrega o plano de treino do Google Apps Script
async function loadTrainingPlan() {
    try {
        // Faz uma requisição GET para a URL do seu Google Apps Script
        const response = await fetch(SCRIPT_URL); // Não precisa de ?action=read se doGet é o padrão
        if (!response.ok) {
            const errorData = await response.json().catch(() => ({ error: "Erro desconhecido ao carregar o plano." }));
            throw new Error(`Erro ao carregar o plano: ${response.status} ${response.statusText}. Detalhes: ${errorData.error || 'N/A'}`);
        }
        const data = await response.json();
        if (data.error) { // Verifica se o script retornou um erro customizado
             throw new Error(`Erro do script: ${data.error}`);
        }
        currentTrainingPlan = data; // Armazena na variável global
        console.log("Plano carregado:", currentTrainingPlan);
        return true;
    } catch (error) {
        console.error("Falha ao carregar o plano de treino do Google Sheets:", error);
        displayErrorMessage(`Não foi possível carregar o plano de treino do Google Sheets. Detalhes: ${error.message}`);
        currentTrainingPlan = null;
        return false;
    }
}

// Função displayErrorMessage (sem modificações necessárias, mas garanta que ela exista)
function displayErrorMessage(message) {
    const workoutDetailsDiv = document.querySelector('.workout-details');
    const weekElement = document.getElementById('weekNumber');
    const dayOfWeekElement = document.getElementById('dayOfWeek');
    const workoutElement = document.getElementById('workoutDescription');
    const notesElement = document.getElementById('workoutNotes');
    const generalMessageElement = document.getElementById('generalMessage');
    const workoutStatusElement = document.getElementById('workoutStatus');
    const markAsDoneButton = document.getElementById('markAsDoneButton');

    workoutDetailsDiv.style.display = 'block';
    weekElement.textContent = '-';
    dayOfWeekElement.textContent = '-';
    workoutElement.textContent = 'Erro';
    workoutElement.style.color = 'red';
    notesElement.textContent = '';
    workoutStatusElement.textContent = '-';
    workoutStatusElement.className = '';
    if(markAsDoneButton) markAsDoneButton.style.display = 'none';
    generalMessageElement.textContent = message;
    generalMessageElement.className = 'message error-message';
}


// Função displayWorkoutForDate (sem modificações na lógica principal,
// mas ela depende que `currentTrainingPlan` seja preenchido corretamente por `loadTrainingPlan`)
// Apenas certifique-se que ela está usando 'status' como booleano.
function displayWorkoutForDate(dateToDisplay) {
    if (!currentTrainingPlan) {
        displayErrorMessage("Plano de treino não carregado. Tente recarregar a página ou verifique a conexão com o Google Sheets.");
        return;
    }

    currentlyDisplayedDate = new Date(dateToDisplay);
    currentlyDisplayedDate.setHours(0, 0, 0, 0);

    const formattedDate = getFormattedDate(currentlyDisplayedDate);
    document.getElementById('currentDisplayedDate').textContent = getDisplayFormattedDate(currentlyDisplayedDate);

    const workoutElement = document.getElementById('workoutDescription');
    const notesElement = document.getElementById('workoutNotes');
    const weekElement = document.getElementById('weekNumber');
    const dayOfWeekElement = document.getElementById('dayOfWeek');
    const generalMessageElement = document.getElementById('generalMessage');
    const workoutDetailsDiv = document.querySelector('.workout-details');
    const workoutStatusElement = document.getElementById('workoutStatus');
    const markAsDoneButton = document.getElementById('markAsDoneButton');

    generalMessageElement.textContent = '';
    generalMessageElement.className = 'message';
    workoutDetailsDiv.style.display = 'none';
    workoutStatusElement.textContent = '-';
    workoutStatusElement.className = '';
    markAsDoneButton.style.display = 'none';
    markAsDoneButton.disabled = false;

    const entryForDate = currentTrainingPlan.find(entry => String(entry.date) === formattedDate);

    if (entryForDate) {
        workoutDetailsDiv.style.display = 'block';
        weekElement.textContent = entryForDate.week;
        dayOfWeekElement.textContent = entryForDate.day;
        workoutElement.textContent = entryForDate.workout;
        notesElement.textContent = entryForDate.notes || '';

        if (typeof entryForDate.status === 'boolean') {
            markAsDoneButton.style.display = 'inline-block';
            if (entryForDate.status === true) {
                workoutStatusElement.textContent = "Feito";
                workoutStatusElement.className = 'status-feito';
                markAsDoneButton.textContent = 'Marcar como Não Feito';
                markAsDoneButton.className = 'button-mark-not-done';
            } else {
                workoutStatusElement.textContent = "Não feito";
                workoutStatusElement.className = 'status-nao-feito';
                markAsDoneButton.textContent = 'Marcar como Feito';
                markAsDoneButton.className = 'button-mark-done';
            }
        } else {
            workoutStatusElement.textContent = "- (status inválido)"; // Indica se o status não for booleano
            markAsDoneButton.style.display = 'none';
        }

        workoutElement.className = 'workout-title';
        if (entryForDate.workout && entryForDate.workout.includes("MARATONA DE BUENOS AIRES")) {
            workoutElement.classList.add('race-day');
            generalMessageElement.textContent = "DIA DA PROVA!";
            generalMessageElement.classList.add('success-message');
        } else if (entryForDate.workout && entryForDate.workout.toLowerCase().includes("descanso")) {
            workoutElement.classList.add('rest-day');
        }
    } else {
        workoutDetailsDiv.style.display = 'block';
        weekElement.textContent = '-';
        dayOfWeekElement.textContent = '-';
        workoutElement.textContent = 'Nenhum treino específico agendado.';
        notesElement.textContent = '';
        workoutStatusElement.textContent = '-';
        markAsDoneButton.style.display = 'none';

        // Lógica para mensagens de fora do intervalo do plano (pode precisar de ajuste se o plano estiver vazio)
        if (currentTrainingPlan && currentTrainingPlan.length > 0) {
            const firstPlanDate = new Date(currentTrainingPlan[0].date + "T00:00:00");
            const lastPlanDate = new Date(currentTrainingPlan[currentTrainingPlan.length - 1].date + "T00:00:00");

            if (firstPlanDate && currentlyDisplayedDate < firstPlanDate) {
                generalMessageElement.textContent = `O plano de treino começa em ${getDisplayFormattedDate(firstPlanDate)}.`;
                generalMessageElement.classList.add('info-message');
            } else if (lastPlanDate && currentlyDisplayedDate > lastPlanDate) {
                generalMessageElement.textContent = "O plano de treino já foi concluído.";
                generalMessageElement.classList.add('info-message');
            } else {
                 generalMessageElement.textContent = "Nenhum treino agendado para esta data.";
                 generalMessageElement.classList.add('warning-message');
            }
        } else {
             generalMessageElement.textContent = "Nenhum treino agendado para esta data ou plano vazio.";
             generalMessageElement.classList.add('warning-message');
        }
    }
    document.getElementById('searchDate').value = getFormattedDate(currentlyDisplayedDate);
}


// MODIFICADO: Event listener para o botão de alternar status do treino
document.getElementById('markAsDoneButton').addEventListener('click', async () => { // Adicionado async
    if (!currentTrainingPlan || !currentlyDisplayedDate) return;

    const formattedDate = getFormattedDate(currentlyDisplayedDate);
    const entryIndex = currentTrainingPlan.findIndex(entry => String(entry.date) === formattedDate);

    if (entryIndex !== -1 && typeof currentTrainingPlan[entryIndex].status === 'boolean') {
        const newStatus = !currentTrainingPlan[entryIndex].status; // Calcula o novo status

        // Prepara os dados para enviar ao Google Apps Script
        const updateData = {
            date: formattedDate,
            status: newStatus
        };

        // Desabilita o botão temporariamente para evitar cliques múltiplos
        const button = document.getElementById('markAsDoneButton');
        button.disabled = true;
        const originalButtonText = button.textContent;
        button.textContent = "Salvando...";

        try {
            // Faz uma requisição POST para a URL do seu Google Apps Script
            const response = await fetch(SCRIPT_URL, {
                method: 'POST',
                mode: 'cors', // Necessário para requisições cross-origin para Apps Script
                cache: 'no-cache',
                headers: {
                    'Content-Type': 'application/json',
                },
                // O Apps Script espera que o corpo seja uma string, então não usamos JSON.stringify aqui
                // CORREÇÃO: Apps Script com e.postData.contents espera uma string, mas se você
                // o analisa com JSON.parse(e.postData.contents), então o cliente DEVE enviar uma string JSON.
                body: JSON.stringify(updateData) // Envia os dados como uma string JSON
            });

            const result = await response.json(); // Espera uma resposta JSON do script

            if (result.success) {
                // Atualiza o status no array local (currentTrainingPlan)
                currentTrainingPlan[entryIndex].status = newStatus;
                // Atualiza a exibição
                displayWorkoutForDate(currentlyDisplayedDate);
                console.log("Status atualizado com sucesso via Google Sheets:", result.message);
            } else {
                console.error("Erro ao atualizar status via Google Sheets:", result.message);
                alert("Erro ao salvar status: " + result.message); // Informa o usuário
                button.textContent = originalButtonText; // Restaura o texto do botão
            }
        } catch (error) {
            console.error("Erro na requisição para atualizar status:", error);
            alert("Erro de comunicação ao salvar status. Verifique o console.");
            button.textContent = originalButtonText; // Restaura o texto do botão
        } finally {
            button.disabled = false; // Reabilita o botão
            if (button.textContent === "Salvando...") { // Garante que o texto seja restaurado se não houve sucesso
                 displayWorkoutForDate(currentlyDisplayedDate); // Re-renderiza para restaurar o texto correto do botão
            }
        }
    }
});

// Funções de navegação e inicialização (searchButton, prevDayButton, nextDayButton, todayButton, initializeApp)
// permanecem as mesmas, mas `initializeApp` agora chamará a `loadTrainingPlan` modificada.

document.getElementById('searchButton').addEventListener('click', () => {
    const dateInput = document.getElementById('searchDate').value;
    if (dateInput) {
        const selectedDate = new Date(dateInput + "T00:00:00");
        displayWorkoutForDate(selectedDate);
    } else {
        const generalMessageElement = document.getElementById('generalMessage');
        generalMessageElement.textContent = "Por favor, selecione uma data.";
        generalMessageElement.className = 'message warning-message';
    }
});

document.getElementById('prevDayButton').addEventListener('click', () => {
    const prevDate = new Date(currentlyDisplayedDate);
    prevDate.setDate(currentlyDisplayedDate.getDate() - 1);
    displayWorkoutForDate(prevDate);
});

document.getElementById('nextDayButton').addEventListener('click', () => {
    const nextDate = new Date(currentlyDisplayedDate);
    nextDate.setDate(currentlyDisplayedDate.getDate() + 1);
    displayWorkoutForDate(nextDate);
});

document.getElementById('todayButton').addEventListener('click', () => {
    displayWorkoutForDate(new Date());
});

async function initializeApp() {
    const planLoaded = await loadTrainingPlan(); // Chama a nova função
    if (planLoaded) {
        displayWorkoutForDate(new Date());
        document.getElementById('searchDate').value = getFormattedDate(new Date());
    }
}

window.onload = initializeApp;

    </script>
</body>
</html>

